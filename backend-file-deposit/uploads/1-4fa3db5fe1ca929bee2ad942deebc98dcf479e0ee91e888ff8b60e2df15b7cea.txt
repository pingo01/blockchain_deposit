202512010

？？上传者手动修改文件状态：正常/失效
？？验证者：文件已失效


存证凭证导出（PDF/JSON）
需求场景：用户存证成功后，需要一份离线凭证（如用于法律证明、备案）。
实现方案：
后端：集成 pdfkit（npm install pdfkit），根据存证记录生成 PDF 凭证（包含存证 ID、文件哈希、区块索引、存证时间等）；
前端：新增 “导出凭证” 按钮，点击后调用后端接口，下载 PDF 文件。

验证报告导出（PDF）

？？上传文件可以写存证描述deposit_desc  remark（算了吧，要改的太多了）
“我们在存证记录中新增了‘备注’字段，允许用户上传文件时填写文件用途、版本等关键信息，方便后续查询识别，贴合真实使用场景；同时支持按备注模糊查询，提升系统的实用性和灵活性，让存证不仅是‘技术验证’，更是‘能解决实际问题的工具’。”


文件列表要显示哪些信息呢？？？？

//密码上限设置
//用户名上限
（√）约束检验/错误提示！！！！！！！！！！！！！！！！

//手机号/用户名登录
//密码重置，身份证号码
（√）密码重置，图形验证码（模拟）


（√）用户注册确认密码！！！
（√）userStore.resetPassword is not a function！！！！！！！！！！！！！！

存证系统标题！！！！！！！！！
页面设计美观！！！！！！！！

存证记录，区块链模型！！
数据库表！！！！！！！！！！！！！！！！！！！！！！
12345678901234567890

用户名3-20位，不能是手机号，仅限大小写字母，数字，一些特殊符号    ! @ # $ % & * ( ) _ + .     ，不能有空格，

! @ # $ % & * ( ) _ + .

昵称1-20位，不能有空格
电话11位
密码6-20位，仅限大小写字母，数字，特殊符号! @ # $ % & * ( ) _ + .，不能有空格
确认密码

注册
重置密码
修改个人信息



用户名3-20位，不能是手机号，仅限大小写字母，数字，特殊符号    ! @ # $ % & * ( ) _ + .    ，不能有空格，
昵称1-20位，不能有空格
电话11位
密码6-20位，仅限大小写字母，数字，特殊符号     ! @ # $ % & * ( ) _ + .     ，不能有空格

现在帮我加约束条件和验证
我们一个一个模块开始做，先从注册开始
注册有关：
用户名
密码
确认密码
昵称
手机号


存证记录表（deposit_record）：业务核心，关联用户与区块
CREATE TABLE `deposit_record` (
  `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID（主键，仅用于数据库内部管理）',
  `deposit_id` VARCHAR(50) NOT NULL UNIQUE COMMENT '存证编号（对外唯一标识，如20251127001，与区块链中一致）',
  `user_id` INT NOT NULL COMMENT '关联用户ID（外键，绑定存证所属用户）',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件原始名称（如"合同.pdf"）',
  `file_hash` VARCHAR(64) NOT NULL COMMENT '文件SHA256哈希（存证核心，防篡改依据）',
  `file_size` INT COMMENT '文件大小（单位：字节，可选）',
  `file_type` VARCHAR(50) COMMENT '文件类型（如application/pdf，可选）',
  `file_url` VARCHAR(512) COMMENT '文件存储路径（本地路径或云存储URL，可选）',
  `deposit_time` DATETIME NOT NULL COMMENT '存证提交时间',
  `block_index` INT NOT NULL COMMENT '关联的区块索引（外键，绑定到blockchain表）',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
存证状态变更时间
记录修改时间
remark备注

CREATE TABLE `deposit_status_log` (
  `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID',
  `deposit_id` VARCHAR(50) NOT NULL COMMENT '关联存证编号',
  `operator_id` INT NOT NULL COMMENT '操作人ID（关联user表）',
  `operator_role` VARCHAR(20) NOT NULL COMMENT '操作人角色',
  `old_status` VARCHAR(20) NOT NULL COMMENT '变更前状态',
  `new_status` VARCHAR(20) NOT NULL COMMENT '变更后状态',
  `operate_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '操作时间',
  FOREIGN KEY (`deposit_id`) REFERENCES `deposit_record`(`deposit_id`) ON DELETE CASCADE,
  FOREIGN KEY (`operator_id`) REFERENCES `user`(`id`) ON DELETE CASCADE,
  INDEX idx_deposit_id (`deposit_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='存证状态变更日志表（审计追溯用）';


  -- 外键约束：保证存证记录与用户、区块的关联性
  FOREIGN KEY (`user_id`) REFERENCES `user`(`id`) ON DELETE CASCADE COMMENT '用户删除时，关联存证记录同步删除',
  FOREIGN KEY (`block_index`) REFERENCES `blockchain`(`block_index`) ON DELETE RESTRICT COMMENT '区块不可删除，避免存证记录关联失效',
  -- 索引：优化查询性能（高频查询字段加索引）
  INDEX idx_user_id (`user_id`) COMMENT '按用户ID查询存证记录',
  INDEX idx_file_hash (`file_hash`) COMMENT '按文件哈希查询存证记录',
  INDEX idx_deposit_time (`deposit_time`) COMMENT '按存证时间筛选存证记录'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='文件存证业务表（存储核心业务信息，关联用户与区块）';

区块链表（blockchain）：存储区块链核心数据，还原链式结构
CREATE TABLE `blockchain` (
  `id` INT PRIMARY KEY AUTO_INCREMENT COMMENT '自增ID（主键，仅用于数据库内部管理）',
  `block_index` INT NOT NULL UNIQUE COMMENT '区块索引（区块链中唯一标识，如0=创世区块，1=第一个存证区块）',
  `prev_block_hash` VARCHAR(64) NOT NULL COMMENT '前一区块的哈希值（链式关联依据）',
  `block_data` TEXT NOT NULL COMMENT '区块数据（存证记录JSON字符串，与deposit_record表对应）',
  `block_time` DATETIME NOT NULL COMMENT '区块生成时间（区块创建时的时间戳）',
  `current_block_hash` VARCHAR(64) NOT NULL COMMENT '当前区块的哈希值（防篡改核心依据）',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '记录创建时间',
  -- 索引：优化区块遍历和验证性能
  INDEX idx_block_index (`block_index`) COMMENT '按区块索引查询区块',
  INDEX idx_prev_block_hash (`prev_block_hash`) COMMENT '验证区块链式关联'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='区块链核心数据表（存储完整区块信息，保证链式防篡改）';




二、存证记录表 deposit_record
字段名	类型	说明	示例
evidence_id	INT PRIMARY KEY AUTO_INCREMENT	存证ID	1001
user_id	INT FOREIGN KEY	上传用户ID	1
file_name	VARCHAR(255)	原始文件名	合同.pdf
file_hash	VARCHAR(64) UNIQUE	文件哈希值（SHA256）	e3b0c442...
file_size	BIGINT	文件大小（字节）	102400
description	TEXT	存证描述	2024年租赁合同
upload_time	TIMESTAMP DEFAULT CURRENT_TIMESTAMP	上传时间	2024-01-01 14:30:00
blockchain_id	INT FOREIGN KEY	关联的区块链记录ID	5001
status	ENUM('pending', 'onchain', 'failed')	上链状态	onchain
核心逻辑：用户上传文件 → 计算file_hash → 等待上链 → 状态更新为onchain


三、区块链表 blockchain_record
字段名	类型	说明	示例
blockchain_id	INT PRIMARY KEY AUTO_INCREMENT	区块链记录ID	5001
tx_hash	VARCHAR(100) UNIQUE	区块链交易哈希	0x5fbc3c...
block_number	BIGINT	区块高度	19283746
blockchain_type	VARCHAR(20)	区块链类型（模拟用）	Ethereum
timestamp	TIMESTAMP	区块时间戳	2024-01-01 14:35:00
gas_used	DECIMAL(18,8)	燃料消耗（模拟数据）	0.0015
confirmations	INT DEFAULT 1	确认数	12





Package         Version
--------------- ------------
graphviz        0.21
Jinja2          3.1.6
joblib          1.5.2
MarkupSafe      3.0.2
numpy           2.3.3
pandas          2.3.2
pandas-stubs    2.3.2.250926
pip             25.2
prettytable     3.16.0
pyecharts       2.0.8
python-dateutil 2.9.0.post0
pytz            2025.2
scikit-learn    1.7.2
scipy           1.16.3
simplejson      3.20.1
six             1.17.0
threadpoolctl   3.6.0
tzdata          2025.2
wcwidth         0.2.13
xgboost         3.1.2